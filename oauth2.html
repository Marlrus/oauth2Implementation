<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <style>
        code{
            background-color: rgba(0,0,0,.075);
            font-weight: bold;
        }
        .subtitle{
            font-size: 1.3rem;
            font-weight: bold;
            margin: 0;
            padding: 5px;
            margin-top: 5px;
            background-color: rgba(0,0,0,.075);
            text-align: center;
        }
        h3{
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
            padding: 5px;
            margin-top: 10px;
        }
        .paragraph{
            margin: 0.5rem 0 0.5rem;
        }
        .tab{
            margin: 0 1rem;
        }
        </style>

    <title>OAuth2 Implementation</title>
  </head>
  <body>
      
    <div class="container">
        <h1 class="display-3 text-center">OAuth2 Implementation<hr></h1>
        <header>
            <p class="paragraph">
                This is study into the implementation of Google OAuth2 for future webApps. Done through the OAuth (Passport.js) Tutorials from <em>The Net Ninja</em> in YouTube.
            </p>
        </header>
        <ul class="list-group">
            <li class="list-group-item">
                <h2 class="subtitle">Intro</h2>
                <p class="paragraph">
                    O Auth stands for Open Authorization and allows to login into an app with 3rd party accounts. This is great for us as developers, and great for users as it centralizes logins. Users will press the button to login, they will be redirected to a consent screen and then they will login to our website. We can store a version of their profile in our app using the data from google. We will do this through <em>passport.js</em>
                </p>
            </li>
            <li class="list-group-item">
                <h2 class="subtitle">OAuth Flow</h2>
                <p class="paragraph">
                    When the user clocks on the button for OAuth, we will redirect them to a route in our webApp <em>/auth/provider</em> where provider is whichever provider they choose to do a 3rd party login with. We handle these routes within our application in our Server Express App (Node). This then redirects to the OAuth provider consent screen that grants permission. We then redirect to a custom route <em>/auth/provider/cb</em> where <u>cb</u> stands for <em>callback</em>. In this route we have access to the user information. Here we handle whether the user has been here before or not and do something depending on the status. For either of these we will have a version of our user in our on db. After that we create a unique cookie which gets sent to the browser. The browser stores that cookie which allows us to navigate pages with your auth through the decoding of the cookie and retrieval of user information. <strong>Note:</strong> There are a few other things that need to be done in between, but this is the main gist of it. 
                </p>
                <p class="paragraph">
                    <strong>Passport</strong>
                    <br>
                    We will use passport when: We handle the "auth/provider" route in our app. When we recieve user details from the provider. When we create a unique cookie. And when we decode the cookie and retrieve user information (serializing and deserializing). 
                </p>
            </li>
            <li class="list-group-item">
                <h2 class="subtitle">Setting up the Express App</h2>
                <p class="paragraph">
                    Just basic setup for an express App using EJS. Copied from other apps of mine. Then we create the basic routes and templates. A few auth routes and we set the navs. I used the partials for navs instead of having them in each template with the style tag. This finishes the setup before installing Passport. 
                </p>
            </li>
            <li class="list-group-item">
                <h2 class="subtitle">Basic Passport Setup</h2>
                <p class="paragraph">
                    We need to install a few packages. One being strategies, which are the ways to login using 3rd party auth. We install two packages <em>passport and passport-google-oauth20</em>. We then create a directory for passport configuration called config. Inside we create a file <em>passport-setup.js</em>. Inside this file we require both packages under the const passport and GoogleStrategy. We then set up the start for the strategy with <code>passport.use(new GoogleStrategy({optionsForStrategy})</code>
                </p>
            </li>
            <li class="list-group-item">
                <h2 class="subtitle">Google Strategy Setup</h2>
                <p class="paragraph">
                    We need to use the GoogleAPI to use OAuth. We are going to need a few things, for auth we need a <em>client ID</em> and a <em>client secret</em> from <em>google developer console</em>. We need a user there to set this up. We need to create a new project here. We then have to Enable APIs and Services, we do this by clicking on the button. For OAuth2.0 we need to use the Google+ API. <strong>Note:</strong> The Google+ API is not the solution, now we must use another API <em>Google People</em>.
                </p>
            </li>
            <li class="list-group-item">
                <h2 class="subtitle">Google API and Credentials</h2>
                <p class="paragraph">
                    We need to go to <a href="console.cloud.google.com" target="_blank">The google Cloud Platform</a> to get the API and credentials we need. First we create a project to manage API Keys and Credentials. Once that is done, we go the API & Services tab and click on Credentials and then create credentials. We add the URL <em>http://localhost:3000</em> and then on the other field add <em>http://localhost:3000/whatever</em> which we will change. Once that is done we get a <em><u>client Id: and client secret</u></em> which we need for the passport-setup. We save these in our .env using the dotenv package which we require with <code>require('dotenv').config()</code> in our <em>.env</em> file we use the following format <code>VARIABLE_NAME=value</code>, we call it in our app using <code>process.env.VARIABLE_NAME</code> <strong>Note:</strong> The Net Ninja uses another way to hide the info through a js file <em>keys.js</em> he uses <code>module.exports = {google: {clientID:'value',clientSecret:'value'}}</code> and adds the file to our .gitignore file so it doesn't get uploaded. He gets them to the template through require <code>const keys = require(./keys)</code> and uses it through <code>keys.google.clientID</code> and the same for clientSecret.
                </p>
            </li>
            <li class="list-group-item">
                <h2 class="subtitle">The Redirect URI</h2>
                <p class="paragraph">
                    We change the Authorized Redirect URIs from our credentials to <em>http://localhost:3000/auth/google/redirect</em> which will be our callback route. We must also add this URI in our GoogleStrategy through <code>callbackURL:'/auth/google/redirect'</code> Now we have to focus on our route that takes the user to our consent screen <code>/auth/google</code>. We require passport in our auth-routes. We change our route to <code>router.get('/google',passport.authenticate('google', scope:['profile']))</code> it uses the passport object, the autheticate method, and it knows through 'google' that it has to redirect to the google consent screen (Something to do with us having a GoogleStrategy). The second parameter is the <em>scope</em> which tells Google what information you want to retireve from the user. Other options can be sought in the Google API, but we just have 'profile' at the moment. We have the set up but we are not using the code anywhere, we need to require it first! To fix this we require it in our app.js through <code>passportSetup   = require('./config/passport-setup')</code> This associates the GoogleStrategy to the passport object. Now we get sent to the google consent screen, however, when we click we get redirected to <em>/auth/google/redirect</em> a route which we haven't handled. This is the route we sepcified in our passport-setup for the GoogleStrategy in the <em>callbackURL</em> property. We create a rote handler with a simple res.send and we see that we have a query string in our URL now <code>redirect?code=4%2FvwGSztOVJw41xi6pOL4-7Mla4DsTzBaY-CFzo1YHUPrZLlB-V1lMcDL9PTMgJP78VDKyJJqajGWn62BlM60qg7k&scope=profile+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fuserinfo.profile#</code> This is what Passport can use to retrieve information from Google. 
                </p>
            </li>
            <li class="list-group-item">
                <h2 class="subtitle">The Passport Callback</h2>
                <p class="paragraph">
                    We just have the query string in the URL. The flow until now user goes through our app to auth/google/ which redirects to the consent screen. This then gives us a code (in the query string) from google in the redirect URI. The next step is to exchange code for information using passport. After this is done, it launchs the passport callback function. We first add <code>passport.authenticate('google')</code> to the <em>/google/redirect</em> route (Reason unclear/something to do with passport getting the info back from google. I removed the code and got sent to the route res.send but got no information). Then we use the callback function. The passport callback function has 4 parameters <code>(accessToken,refreshToken,profile,done)=>{}</code> accessToken gives us access to whatever information the client consented to, refreshToken refreshes the duration of the accessToken (it expires), profile is the information for the profile (defined in scope), and done is what lets us leave the function. Insde the function we use <code>console.log(profile)</code> which returns the information JSON object. 
                </p>
            </li>
            <li class="list-group-item">
                <h2 class="subtitle">Creating a DB on mLab</h2>
                <p class="paragraph">
                    What we want to do with the callback is lookup/create user on our db (mongo in this case). mLab is like mongoDB Atlas. I will use mongoDB Atlas instead. I do the standard process I often do now and set up the URI in the .env file.
                </p>
            </li>
            <li class="list-group-item">
                <h2 class="subtitle">Making the User Model</h2>
                <p class="paragraph">
                    
                </p>
            </li>
        </ul>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    </body>
</html>